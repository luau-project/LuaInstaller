name: CI

on:
  push:
    paths-ignore:
      - "**.md"
      - "docs/**"
  pull_request:
    paths-ignore:
      - "**.md"
      - "docs/**"

env:
  LUAINSTALLER_VERSION: 0.1.1.0
  LUAROCKS_VERSION: 3.11.1

jobs:
  build:
    runs-on: windows-latest
    name: Build

    strategy:
      matrix:

        LUA_VERSION:
          - 5.1.5
          - 5.2.4
          - 5.3.6
          - 5.4.7
        
        ARCH:
          - x64
          - x86
        
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: LuaInstaller
      
      - name: Set environment variables
        run: |
          $wpf_dir = Join-Path "${{ runner.temp }}" -ChildPath LuaInstaller.EndUsers;
          $console_dir = Join-Path "${{ runner.temp }}" -ChildPath LuaInstaller.Console;

          Add-Content "${{ github.env }}" "WPF_DIR=${wpf_dir}";
          Add-Content "${{ github.env }}" "CONSOLE_DIR=${console_dir}";

      - name: Setup dotnet
        run: |
          $dotnet_dir = Join-Path -Path "${{ runner.temp }}" -ChildPath "dotnet_dir";

          New-Item $dotnet_dir -ItemType Directory;

          $dotnet_install_file = Join-Path -Path $dotnet_dir -ChildPath "dotnet-install.ps1";
          $dotnet_runner = Join-Path -Path $dotnet_dir -ChildPath "dotnet";

          Invoke-WebRequest -Uri 'https://dot.net/v1/dotnet-install.ps1' -UseBasicParsing -OutFile $dotnet_install_file;
          & $dotnet_install_file -Architecture "${{ matrix.ARCH }}" -Version "6.0.427" -InstallDir $dotnet_dir;

          Add-Content "${{ github.env }}" "DOTNET_RUNNER=${dotnet_runner}";

      - name: Restore the solution
        run: |
          & "${{ env.DOTNET_RUNNER }}" `
            restore LuaInstaller\LuaInstaller.sln

      - name: Build LuaInstaller.Console
        run: |
          & "${{ env.DOTNET_RUNNER }}" `
            publish LuaInstaller\LuaInstaller.Console\LuaInstaller.Console.csproj `
            -o "${{ env.CONSOLE_DIR }}" `
            -c Release `
            -r win-${{ matrix.ARCH }} `
            --self-contained true

      - name: Build LuaInstaller
        run: |
          & "${{ env.DOTNET_RUNNER }}" `
            publish LuaInstaller\LuaInstaller\LuaInstaller.csproj `
            -o "${{ env.WPF_DIR }}" `
            -c Release `
            -r win-${{ matrix.ARCH }} `
            --self-contained true

      - name: Setup Lua and LuaRocks environment variables
        run: |
          $lua_dir = Join-Path -Path "${{ runner.temp }}" -ChildPath "Lua";
          $luarocks_dir = Join-Path -Path "${{ runner.temp }}" -ChildPath "luarocks-${{ env.LUAROCKS_VERSION }}-windows-64";
          $lfs_test_file = Join-Path -Path "${{ runner.temp }}" -ChildPath "lfs-test.lua";

          Add-Content "${{ github.env }}" "LUA_DIR=${lua_dir}";
          Add-Content "${{ github.env }}" "LUAROCKS_DIR=${luarocks_dir}";
          Add-Content "${{ github.env }}" "LFS_TEST_FILE=${lfs_test_file}";
      
      - name: Test LuaInstaller.Console installing Lua ${{ matrix.LUA_VERSION }}
        run: |
          $console = Join-Path "${{ env.CONSOLE_DIR }}" -ChildPath "LuaInstaller.Console.exe";
          
          $commands = "/?", "list-win-sdk", "list-vs-${{ matrix.ARCH }}", "list-lua";
          $color = (0x1b -as [char]) + "[35m";

          foreach ($c in $commands) {
            Write-Host;
            Write-Host "${color}command: ${c}";
            Write-Host;
            & $console $c;
            Write-Host;
          }
          
          & $console install `
            "dest-dir=${{ env.LUA_DIR }}" `
            arch=${{ matrix.ARCH }} `
            "version=${{ matrix.LUA_VERSION }}";
          
          $luaBinDir = Join-Path -Path "${{ env.LUA_DIR }}" -ChildPath "bin";
          $luaExe = Join-Path -Path $luaBinDir -ChildPath "lua.exe";

          & $luaExe -v

      - name: Download LuaRocks
        run: Invoke-WebRequest -Uri https://luarocks.org/releases/luarocks-${{ env.LUAROCKS_VERSION }}-windows-64.zip -OutFile luarocks-${{ env.LUAROCKS_VERSION }}-windows-64.zip
      
      - name: Extract LuaRocks
        run: Expand-Archive luarocks-${{ env.LUAROCKS_VERSION }}-windows-64.zip -DestinationPath ([System.IO.Path]::GetDirectoryName("${{ env.LUAROCKS_DIR }}"))
      
      - name: Add Lua and LuaRocks to system PATH environment variable
        run: |
          $luaBinDir = Join-Path -Path "${{ env.LUA_DIR }}" -ChildPath "bin";

          Add-Content "${{ github.path }}" "$luaBinDir";
          Add-Content "${{ github.path }}" "${{ env.LUAROCKS_DIR }}";
      
      - name: Setup MSVC dev-prompt for LuaRocks configuration
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.ARCH }}
      
      - name: Configure LuaRocks for Lua ${{ env.LUA_VERSION }}
        run: |
          luarocks config lua_dir "${{ env.LUA_DIR }}"
          
          if ("${{ matrix.LUA_VERSION }}" -match "^(\d+)\.(\d+)(\.\d+)*$")
          {
            $LUA_SHORT_VERSION=$Matches.1 + "." + $Matches.2
            luarocks config lua_version $LUA_SHORT_VERSION
          }
          else
          {
            Write-Host "Invalid Lua version: ${{ matrix.LUA_VERSION }}";
            exit /B 1;
          }
      
      - name: Update environment variables with variables from LuaRocks
        run: |
          $luarocks_path = luarocks.exe path
          Add-Content "${{ github.env }}" $luarocks_path.Replace("""", "").Replace("'", "").Replace("SET ", "")
      
      - name: Install LuaFileSystem
        run: luarocks install luafilesystem
      
      # https://lunarmodules.github.io/luafilesystem/examples.html
      - name: Create a Test file for LuaFileSystem
        run: |
          $test_script = @'
          local lfs = require"lfs"

          function attrdir (path)
              for file in lfs.dir(path) do
                  if file ~= "." and file ~= ".." then
                      local f = path..'/'..file
                      print ("\t "..f)
                      local attr = lfs.attributes (f)
                      assert (type(attr) == "table")
                      if attr.mode == "directory" then
                          attrdir (f)
                      else
                          for name, value in pairs(attr) do
                              print (name, value)
                          end
                      end
                  end
              end
          end

          attrdir (".")
          '@

          Set-Content "${{ env.LFS_TEST_FILE }}" $test_script -NoNewLine

      - name: Test LuaFileSystem
        run: lua "${{ env.LFS_TEST_FILE }}"
      
      - name: Prepare artifacts to upload
        if: ${{ matrix.LUA_VERSION == '5.4.7' && (github.ref_name == 'release' || startsWith(github.ref, 'refs/tags/')) }}
        run: |
          mkdir release;
          $dirs_to_archive = "${{ env.CONSOLE_DIR }}", "${{ env.WPF_DIR }}";

          foreach ($dir in $dirs_to_archive)
          {
            $archive_name = (Get-Item $dir | Select-Object -ExpandProperty Name) + "-v${{ env.LUAINSTALLER_VERSION }}-${{ matrix.ARCH }}.zip";
            $archive_path = Join-Path -Path "release" -ChildPath $archive_name;

            Compress-Archive -Path $dir -DestinationPath $archive_path;

            $current_file_sha256_hash = Get-FileHash $archive_path -Algorithm SHA256 | Select-Object -ExpandProperty Hash;
            $current_file_md5_hash = Get-FileHash $archive_path -Algorithm MD5 | Select-Object -ExpandProperty Hash;
            $current_file_sha256_file = Join-Path -Path "release" -ChildPath ($archive_name + "-SHA256.txt");
            $current_file_md5_file = Join-Path -Path "release" -ChildPath ($archive_name + "-MD5.txt");
            Set-Content -Path $current_file_sha256_file -Value $current_file_sha256_hash -NoNewline;
            Set-Content -Path $current_file_md5_file -Value $current_file_md5_hash -NoNewline;
          }
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: ${{ matrix.LUA_VERSION == '5.4.7' && (github.ref_name == 'release' || startsWith(github.ref, 'refs/tags/')) }}
        with:
          name: release-v${{ env.LUAINSTALLER_VERSION }}-${{ matrix.ARCH }}
          path: release
          retention-days: 1
          if-no-files-found: error
  
  test-on-lgi:
    runs-on: windows-latest
    name: Test on LGI

    strategy:
      matrix:

        LUA_VERSION:
          - 5.1.5
          - 5.2.4
          - 5.3.6
          - 5.4.7
        
        GTK_MAJOR_VERSION:
          - 3
          - 4
    
    env:
      ARCH: x64
      WINGTK_URL: https://github.com/wingtk/gvsbuild/releases/download/2024.10.0/GTK${{ matrix.GTK_MAJOR_VERSION }}_Gvsbuild_2024.10.0_x64.zip
      
    steps:

      - name: Download and extract GTK ${{ matrix.GTK_MAJOR_VERSION }} prebuilt binaries (MSVC toolset) provided by wingtk
        run: |
          $gtk_zip_file = Join-Path -Path "${{ runner.temp }}" -ChildPath "gtk.zip";
          
          # Download
          Invoke-WebRequest -Uri ${{ env.WINGTK_URL }} -OutFile $gtk_zip_file;
          
          # Unzip
          $gtk_dir = Join-Path -Path "${{ runner.temp }}" -ChildPath "gtk";
          Expand-Archive -Path $gtk_zip_file -DestinationPath "${gtk_dir}";

          $gtk_bin_dir = Join-Path -Path $gtk_dir -ChildPath "bin";
          
          # Set environment variable GTK_DIR pointing to GTK's directory
          Add-Content "${{ github.env }}" "GTK_DIR=${gtk_dir}";
          
          # Set environment variable GTK_BIN_DIR pointing to GTK's bin directory
          Add-Content "${{ github.env }}" "GTK_BIN_DIR=${gtk_bin_dir}";

          # Place GTK bin directory on system PATH environment variable
          Add-Content "${{ github.path }}" "${gtk_bin_dir}";
      
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: LuaInstaller
      
      - name: Install Lua ${{ matrix.LUA_VERSION }} on GTK's directory through LuaInstaller.Console, and set environment variables
        run: |
          $console_dir = Join-Path "${{ runner.temp }}" -ChildPath LuaInstaller.Console;

          $dotnet_dir = Join-Path -Path "${{ runner.temp }}" -ChildPath "dotnet-dir";

          New-Item $dotnet_dir -ItemType Directory;

          $dotnet_install_file = Join-Path -Path $dotnet_dir -ChildPath "dotnet-install.ps1";
          $dotnet_runner = Join-Path -Path $dotnet_dir -ChildPath "dotnet";

          Invoke-WebRequest -Uri 'https://dot.net/v1/dotnet-install.ps1' -UseBasicParsing -OutFile $dotnet_install_file;
          & $dotnet_install_file -Architecture "${{ env.ARCH }}" -Version "6.0.427" -InstallDir $dotnet_dir;
          
          & $dotnet_runner `
            restore LuaInstaller\LuaInstaller.sln;
          
          & $dotnet_runner `
            publish LuaInstaller\LuaInstaller.Console\LuaInstaller.Console.csproj `
            -o "${console_dir}" `
            -c Release `
            -r win-${{ env.ARCH }} `
            --self-contained true;
            
          $console = Join-Path -Path "${console_dir}" -ChildPath "LuaInstaller.Console.exe";
          
          & $console install `
            "dest-dir=${{ env.GTK_DIR }}" `
            arch=${{ env.ARCH }} `
            "version=${{ matrix.LUA_VERSION }}";
          
          & lua -v;
          
          $lua_pc = Get-ChildItem "${{ env.GTK_DIR }}" -Recurse -File |
            Where-Object Name -Like "lua*.pc" |
            Select-Object -ExpandProperty BaseName -First 1;

          # Append LUA_PC environment variable to help lgi configuration
          Add-Content "${{ github.env }}" "LUA_PC=${lua_pc}";

          $lua_short_version = "${{ matrix.version }}" -split "\." |
            Select-Object -First 2 |
            Join-String -Separator ".";
          
          # Append LUA_SHORT_VERSION environment variable to help LuaRocks configuration, when needed.
          Add-Content "${{ github.env }}" "LUA_SHORT_VERSION=${lua_short_version}";
      
      # Initial lgi setup (checkout + Python 3.12 + meson + ninja)
      - name: Checkout lgi
        uses: actions/checkout@v4
        with:
          repository: lgi-devs/lgi
          path: lgi

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install meson
        run: pip install meson
      
      - name: Install ninja
        run: pip install ninja

      - name: Setup MSVC dev-prompt
        uses: ilammy/msvc-dev-cmd@v1
      
      - name: Configure lgi through meson
        run: meson setup build-lgi lgi --prefix "${{ env.GTK_DIR }}" --buildtype release "-Dlua-pc=${{ env.LUA_PC }}" -Dtests=false
    
      - name: Build lgi
        run: meson compile -C build-lgi
      
      - name: Install lgi
        run: meson install -C build-lgi

      - name: Create a simple test script using lgi
        run: |
          $test_script = @'
          local lgi = assert(require("lgi"))
          local Gtk = assert(lgi.require("Gtk", "${{ matrix.GTK_MAJOR_VERSION }}.0"))

          local app = Gtk.Application({ application_id = "org.lgi-devs.lgi" })

          function app:on_activate()
              local w = Gtk.ApplicationWindow()
              w:set_default_size(900, 600)
              w:set_title("My great title")

              w.application = self

              if ("${{ matrix.GTK_MAJOR_VERSION }}" == "3") then
                  w:show_all()
              elseif ("${{ matrix.GTK_MAJOR_VERSION }}" == "4") then
                  w:present()
              else
                  error("Unknown GTK version")
              end

              w:close()
          end

          app:run()
          '@;
          
          $test_file = Join-Path -Path "${{ runner.temp }}" -ChildPath "small-lgi-test.lua";

          Set-Content $test_file $test_script -NoNewLine;

          # Set the test file name on LGI_TEST_FILE environment variable
          Add-Content "${{ github.env }}" "LGI_TEST_FILE=${test_file}";

      - name: Test lgi
        run: lua "${{ env.LGI_TEST_FILE }}"