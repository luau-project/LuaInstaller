version: 1.0.{build}
image:
- Visual Studio 2022
- Visual Studio 2019
- Visual Studio 2017
configuration: Release
platform: Any CPU
build_script:
- pwsh: "$dotnet_dir = Join-Path -Path (Get-Location) -ChildPath \"dotnet_dir\";\n\nNew-Item $dotnet_dir -ItemType Directory;\n\n$dotnet_install_file = Join-Path -Path $dotnet_dir -ChildPath \"dotnet-install.ps1\";\n$dotnet_runner = Join-Path -Path $dotnet_dir -ChildPath \"dotnet\";\n\nInvoke-WebRequest -Uri 'https://dot.net/v1/dotnet-install.ps1' -UseBasicParsing -OutFile $dotnet_install_file;\n& $dotnet_install_file -Architecture x64 -Version \"6.0.301\" -InstallDir $dotnet_dir;\n\n$archs = 'x64', 'x86';\n\nforeach ($arch in $archs) {\n    $directories_to_clean = \".\\LuaInstaller.Console\\bin\", \".\\LuaInstaller.Console\\obj\", \".\\LuaInstaller\\bin\", \".\\LuaInstaller\\obj\";\n\n    foreach ($dir_to_clean in $directories_to_clean) {\n        if (Test-Path $dir_to_clean) {\n            Remove-Item $dir_to_clean -Recurse;\n        }\n    }\n    \n    & $dotnet_runner restore LuaInstaller.sln;\n    & $dotnet_runner build .\\LuaInstaller.Console\\LuaInstaller.Console.csproj -c Release -r win-$arch --self-contained true;\n    & $dotnet_runner build .\\LuaInstaller\\LuaInstaller.csproj -c Release -r win-$arch --self-contained true;\n\n    $console = \".\\LuaInstaller.Console\\bin\\Any CPU\\Release\\net6.0-windows\\win-$arch\\LuaInstaller.Console.exe\";\n\n    $commands = \"/?\", \"list-win-sdk\", \"list-vs-$arch\", \"list-lua\";\n\n    foreach ($c in $commands) {\n        Write-Host;\n        Write-Host command: $c -ForegroundColor Cyan;\n        & $console $c;\n        Write-Host;\n    }\n\n    $lua_versions = \"5.1.5\", \"5.2.4\", \"5.3.6\", \"5.4.6\";\n\n    $current_dir = Get-Location;\n\n    foreach ($lua_ver in $lua_versions) {\n        Write-Host;\n        Write-Host Installing Lua $lua_ver;\n        $lua_ver_dir = Join-Path -Path $current_dir -ChildPath $lua_ver | Join-Path -ChildPath $arch;\n\n        & $console install \"dest-dir=$lua_ver_dir\" version=$lua_ver arch=$arch;\n        \n        $lua_exe_dir = Join-Path -Path $lua_ver_dir -ChildPath 'bin';\n        $lua_exe = Join-Path -Path $lua_exe_dir -ChildPath 'lua.exe';\n        Write-Host Executable file: $lua_exe;\n\n        Write-Host;\n        Write-Host Testing Lua:\n        Write-Host;\n        & $lua_exe -v;\n\n        Write-Host;\n    }\n}"